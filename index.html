<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>LacMapper‚Ñ¢ - Portal de Mapas e Scripts</title>
    <meta name="description" content="A maior comunidade de compartilhamento de mapas e scripts para jogos. Baixe, vote e publique seus mapas no LacMapper‚Ñ¢ de gra√ßa.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estiliza√ß√£o Base */
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617; 
            color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .active-tab { 
            color: #3b82f6; 
            border-bottom: 3px solid #3b82f6; 
        }

        /* Sistema de Crop */
        #crop-container { 
            aspect-ratio: 16/9; 
            overflow: hidden; 
            position: relative; 
            background: #000; 
            border-radius: 16px; 
            touch-action: none; 
            border: 2px solid rgba(59, 130, 246, 0.3); 
        }

        #crop-image-element { 
            position: absolute; 
            cursor: move; 
            touch-action: none; 
            user-select: none; 
            max-width: none; 
        }

        /* Auxiliares */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        button { transition: all 0.1s ease; }
        button:active { transform: scale(0.95); }
        
        .card-anim { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .hidden { display: none !important; }

        /* Slots de An√∫ncios */
        .ad-slot-main {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: hidden;
            margin: 15px auto;
            min-height: 50px;
        }

        .ad-scaler-el { 
            transform-origin: top center; 
            display: inline-block; 
            flex-shrink: 0;
        }
    </style>
</head>
<body class="pb-24">

    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[250] hidden pointer-events-none transition-all duration-300">
        <div class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-white/20">
            <span id="toast-text" class="text-[10px] font-black uppercase tracking-wider"></span>
        </div>
    </div>

    <nav class="fixed top-0 w-full z-50 glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.reload()">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center overflow-hidden border border-white/10 shadow-lg">
                    <img src="1000132243.png" alt="Logo" class="w-full h-full object-contain p-1">
                </div>
                <span class="text-xl font-black italic tracking-tighter uppercase hidden xs:block">LacMapper‚Ñ¢</span>
            </div>

            <div class="flex items-center gap-3">
                <div id="nav-unlogged">
                    <button id="btn-trigger-login" class="bg-white text-black text-[10px] font-black uppercase px-6 py-2.5 rounded-full shadow-lg">Entrar</button>
                </div>
                <div id="nav-logged" class="hidden flex items-center gap-3">
                    <img id="nav-avatar" class="w-9 h-9 rounded-full border-2 border-blue-500/50 object-cover shadow-lg cursor-pointer" src="">
                    <button id="btn-pre-post" class="bg-blue-600 text-white p-2.5 rounded-xl shadow-lg">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                    <button id="btn-trigger-logout" class="p-2 text-slate-500 hover:text-rose-500 transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <header id="main-header" class="pt-24 px-4 max-w-7xl mx-auto w-full">
        <div class="flex items-center gap-4 border-b border-white/5 mb-8 overflow-x-auto no-scrollbar">
            <button id="tab-recent" class="px-5 py-4 text-[10px] font-black uppercase tracking-[0.25em] active-tab transition-all whitespace-nowrap">Recentes</button>
            <button id="tab-popular" class="px-5 py-4 text-[10px] font-black uppercase tracking-[0.25em] text-slate-500 transition-all whitespace-nowrap">Populares</button>
        </div>
        
        <div class="relative max-w-lg mb-6 mx-auto">
            <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-500 w-5 h-5"></i>
            <input type="text" id="input-search" placeholder="Pesquisar mapas ou autores..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-4.5 pl-14 pr-6 outline-none focus:ring-2 focus:ring-blue-500/50 transition-all text-sm font-bold">
        </div>

        <div class="ad-slot-main">
            <div id="ad-scaler-1" class="ad-scaler-el">
                <script type="text/javascript">
                  atOptions = { 'key' : 'f2fc11825c77506816279c5b1393084e', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
                </script>
                <script type="text/javascript" src="https://www.highperformanceformat.com/f2fc11825c77506816279c5b1393084e/invoke.js"></script>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 flex-grow w-full">
        <div id="loading" class="py-24 text-center">
            <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-black uppercase text-slate-600 tracking-widest text-[10px]">Sincronizando Banco de Dados‚Ñ¢...</p>
        </div>

        <div id="map-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>

        <div id="profile-view" class="hidden animate-in fade-in duration-500">
            <div class="glass rounded-[3rem] p-8 mb-12 flex flex-col md:flex-row items-center gap-8 border-white/10">
                <img id="prof-img" src="" class="w-32 h-32 rounded-full border-4 border-blue-600 shadow-2xl object-cover">
                <div class="flex-grow text-center md:text-left">
                    <h2 id="prof-name" class="text-3xl font-black uppercase italic tracking-tighter mb-1">...</h2>
                    <p id="prof-handle" class="text-blue-500 font-bold mb-4 uppercase tracking-widest text-xs">@...</p>
                    <div class="flex flex-wrap justify-center md:justify-start gap-4">
                        <div class="bg-white/5 px-4 py-2 rounded-xl border border-white/5">
                            <p class="text-[8px] font-black uppercase text-slate-500">Downloads Totais</p>
                            <p id="prof-stat-dl" class="text-lg font-black italic">0</p>
                        </div>
                        <div class="bg-white/5 px-4 py-2 rounded-xl border border-white/5">
                            <p class="text-[8px] font-black uppercase text-slate-500">Likes Recebidos</p>
                            <p id="prof-stat-likes" class="text-lg font-black italic">0</p>
                        </div>
                        <div class="bg-white/5 px-4 py-2 rounded-xl border border-white/5">
                            <p class="text-[8px] font-black uppercase text-slate-500">Membro Desde</p>
                            <p id="prof-stat-date" class="text-lg font-black italic">--/--/--</p>
                        </div>
                    </div>
                </div>
                <button id="btn-like-profile" class="bg-blue-600 p-5 rounded-3xl shadow-xl active:scale-90 transition-all">
                    <i data-lucide="heart" class="w-8 h-8 text-white fill-white"></i>
                </button>
            </div>
            <h3 class="font-black uppercase tracking-widest text-xs mb-6 text-slate-500 italic">Contribui√ß√µes do Autor</h3>
            <div id="prof-maps-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
        </div>

        <div id="comments-view" class="hidden max-w-2xl mx-auto animate-in slide-in-from-bottom duration-500">
            <button onclick="window.location.reload()" class="flex items-center gap-2 text-slate-500 font-black uppercase text-[10px] mb-8">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar ao Feed
            </button>
            
            <div id="comment-map-info" class="mb-10 p-6 glass rounded-3xl border-blue-500/20">
                <h2 id="comm-map-title" class="text-2xl font-black uppercase italic">...</h2>
                <p class="text-xs text-slate-500 uppercase font-bold">Discuss√£o da Comunidade</p>
            </div>

            <div class="mb-8 glass p-4 rounded-3xl border-blue-500/20 overflow-hidden">
                <p class="text-[7px] font-black uppercase text-slate-500 mb-2">Sugest√£o Promovida</p>
                <script async="async" data-cfasync="false" src="https://pl28308463.effectivegatecpm.com/1f32791f740b14e44a8b9a32b19185f7/invoke.js"></script>
                <div id="container-1f32791f740b14e44a8b9a32b19185f7"></div>
            </div>

            <div id="comment-input-area" class="mb-8 hidden">
                <textarea id="input-comment" placeholder="Escreva o que achou deste mapa..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500 text-sm h-24 mb-2 no-scrollbar"></textarea>
                <button id="btn-send-comment" class="bg-blue-600 w-full py-4 rounded-xl font-black uppercase text-xs shadow-lg">Publicar Coment√°rio</button>
            </div>
            <div id="comments-list" class="space-y-4"></div>
        </div>
    </main>

    <div id="modal-interstitial" class="fixed inset-0 z-[150] bg-slate-950 flex flex-col items-center justify-center p-6 hidden">
        <div class="text-center mb-8">
            <h3 class="text-2xl font-black uppercase italic mb-2">Aguarde a Sincroniza√ß√£o</h3>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Validando integridade dos an√∫ncios para liberar o upload.</p>
        </div>
        
        <div class="bg-white/5 p-2 rounded-2xl border border-white/10 mb-8">
            <script type="text/javascript">
                atOptions = { 'key' : '745cf56074e768501f24905439e2eb11', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
            </script>
            <script type="text/javascript" src="https://www.highperformanceformat.com/745cf56074e768501f24905439e2eb11/invoke.js"></script>
        </div>

        <button id="btn-close-interstitial" disabled class="w-full max-w-xs bg-slate-800 text-slate-500 py-5 rounded-full font-black uppercase text-sm opacity-50">
            Dispon√≠vel em <span id="inter-timer">5</span>s
        </button>
    </div>

    <div id="modal-download" class="fixed inset-0 z-[120] glass flex items-center justify-center p-4 hidden">
        <div class="bg-[#0f172a] w-full max-w-sm rounded-[2.5rem] border border-white/10 p-8 text-center animate-in zoom-in duration-300">
            <div class="w-16 h-16 bg-blue-600/20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="download-cloud" class="text-blue-500 w-8 h-8"></i>
            </div>
            <h3 class="font-black uppercase italic text-xl mb-2">Preparando Arquivo</h3>
            <p class="text-[10px] font-bold text-slate-500 uppercase mb-8">O download ser√° liberado em instantes.</p>
            
            <button id="btn-confirm-download" disabled class="w-full bg-slate-800 text-slate-500 py-5 rounded-[1.5rem] font-black uppercase text-sm opacity-50 mb-4 shadow-xl">
                Aguarde <span id="dl-timer">5</span>s
            </button>
            <button onclick="document.getElementById('modal-download').classList.add('hidden')" class="text-[10px] font-black uppercase text-slate-600 hover:text-white">Cancelar Opera√ß√£o</button>
        </div>
    </div>

    <div id="modal-post" class="fixed inset-0 z-[100] glass flex items-center justify-center p-4 hidden">
        <div class="bg-[#0f172a] w-full max-w-lg rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                <h3 class="font-black uppercase tracking-tighter italic text-xl">Novo Mapa</h3>
                <button id="btn-close-post" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto no-scrollbar">
                <input id="post-title" type="text" placeholder="Nome do Mapa" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none font-bold focus:border-blue-500">
                <textarea id="post-desc" placeholder="Detalhes t√©cnicos ou descri√ß√£o..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 h-24 outline-none focus:border-blue-500"></textarea>
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="btn-trigger-file" class="bg-white/5 border-2 border-dashed border-white/10 rounded-2xl py-8 flex flex-col items-center gap-2">
                        <i data-lucide="file-text" class="text-blue-500"></i>
                        <span id="file-label" class="text-[9px] font-black uppercase">Selecionar TXT</span>
                    </button>
                    <input type="file" id="post-file" class="hidden" accept=".txt">
                    
                    <button id="btn-trigger-image" class="bg-white/5 border-2 border-dashed border-white/10 rounded-2xl py-8 flex flex-col items-center gap-2">
                        <i data-lucide="image" class="text-blue-500"></i>
                        <span id="image-label" class="text-[9px] font-black uppercase">Capa 16:9</span>
                    </button>
                    <input type="file" id="post-image" class="hidden" accept="image/*">
                </div>

                <div id="crop-area" class="hidden">
                    <div id="crop-container"><img id="crop-image-element" src=""></div>
                    <div class="flex justify-center gap-4 mt-4">
                        <button id="btn-crop-zoom-out" class="bg-white/5 p-3 rounded-xl"><i data-lucide="minus"></i></button>
                        <button id="btn-crop-zoom-in" class="bg-white/5 p-3 rounded-xl"><i data-lucide="plus"></i></button>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-white/5 border-t border-white/10">
                <button id="btn-submit-map" class="w-full bg-blue-600 py-5 rounded-[1.5rem] text-sm font-black uppercase shadow-xl">Publicar Agora</button>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 z-[100] glass flex items-center justify-center p-4 hidden">
        <div class="bg-[#0f172a] w-full max-w-sm rounded-[2.5rem] border border-white/10 p-8 flex flex-col animate-in zoom-in duration-300">
            <h3 id="auth-header-title" class="font-black uppercase italic text-xl mb-6">Acessar Conta</h3>
            
            <div id="auth-register-only" class="hidden space-y-4 mb-4">
                <div class="flex flex-col items-center gap-2">
                    <label class="cursor-pointer">
                        <div class="w-16 h-16 rounded-full bg-slate-800 border-2 border-dashed border-white/20 flex items-center justify-center overflow-hidden">
                            <img id="auth-avatar-preview" class="hidden w-full h-full object-cover">
                            <i id="auth-cam" data-lucide="camera" class="text-slate-500"></i>
                        </div>
                        <input type="file" id="auth-avatar-input" class="hidden" accept="image/*">
                    </label>
                </div>
                <input id="auth-name" type="text" placeholder="Nome Completo" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none font-bold">
            </div>

            <input id="auth-handle" type="text" placeholder="identificador" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none font-bold mb-4">
            <input id="auth-pass" type="password" placeholder="Senha" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none font-bold mb-6">
            
            <div id="auth-error-msg" class="text-rose-500 text-[10px] font-black uppercase text-center mb-4 hidden">Dados Inv√°lidos</div>
            
            <button id="btn-auth-confirm" class="w-full bg-blue-600 py-5 rounded-3xl font-black uppercase shadow-xl mb-4">Confirmar</button>
            <p id="btn-auth-toggle" class="text-center text-[10px] font-black uppercase text-slate-500 cursor-pointer">N√£o tem conta? Criar agora</p>
            
            <button onclick="document.getElementById('modal-auth').classList.add('hidden')" class="mt-6 text-xs font-bold text-slate-600">Fechar Janela</button>
        </div>
    </div>

    <div class="ad-slot-main mt-12">
        <div id="ad-scaler-2" class="ad-scaler-el">
            <script type="text/javascript" src="https://pl28308314.effectivegatecpm.com/c0/32/00/c032003c376ec812a388135541d20cf3.js"></script>
        </div>
    </div>

    <footer class="mt-auto py-12 border-t border-white/5 bg-slate-950/50 text-center">
        <div class="text-[11px] font-black uppercase tracking-[0.5em] mb-4 text-slate-400 italic">LacMapper‚Ñ¢ 2025</div>
    </footer>

    <script type="text/javascript" src="https://pl28308406.effectivegatecpm.com/00/44/ac/0044ac3f97883bf6459286966e37657e.js"></script>

    <script type="module">
        // Importa√ß√£o Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKhcg84B_EqFKJ6Xe_EZnW1KRq-T_gcwU",
            authDomain: "jogo2donline.firebaseapp.com",
            databaseURL: "https://jogo2donline-default-rtdb.firebaseio.com",
            projectId: "jogo2donline",
            storageBucket: "jogo2donline.firebasestorage.app",
            messagingSenderId: "782226902162",
            appId: "1:782226902162:web:d316d0b3a62acac6afaa4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Estado Global
        let userSession = JSON.parse(localStorage.getItem('lac_user')) || null;
        let dataMaps = [];
        let dataUsers = {};
        let tabMode = 'recentes';
        let authIsRegister = false;
        let cropInfo = { x: 0, y: 0, scale: 1, dragging: false, startX: 0, startY: 0 };
        let tempAvatar = "";
        let tempFile = { content: "", size: 0 };
        let dlTarget = null;

        // --- CORE SYNC ---
        const startSync = () => {
            onValue(ref(db, 'lacmapper/users'), (snap) => { 
                dataUsers = snap.val() || {}; 
                if(userSession) userSession = dataUsers[userSession.handle];
            });
            onValue(ref(db, 'lacmapper/maps'), (snap) => {
                const raw = snap.val(); dataMaps = [];
                if (raw) for (let key in raw) dataMaps.push({ ...raw[key], id: key });
                document.getElementById('loading').classList.add('hidden');
                renderMaps();
            });
        };
        startSync();

        // --- UI HELPERS ---
        const showToast = (t) => {
            const el = document.getElementById('toast');
            document.getElementById('toast-text').innerText = t;
            el.classList.remove('hidden');
            setTimeout(()=>el.classList.add('hidden'), 3000);
        };

        const refreshNav = () => {
            document.getElementById('nav-unlogged').classList.toggle('hidden', !!userSession);
            document.getElementById('nav-logged').classList.toggle('hidden', !userSession);
            if(userSession) document.getElementById('nav-avatar').src = userSession.avatar;
        };
        refreshNav();

        // --- AUTH SYSTEM ---
        document.getElementById('btn-trigger-login').onclick = () => document.getElementById('modal-auth').classList.remove('hidden');
        document.getElementById('btn-auth-toggle').onclick = () => {
            authIsRegister = !authIsRegister;
            document.getElementById('auth-header-title').innerText = authIsRegister ? "Criar Conta" : "Login";
            document.getElementById('auth-register-only').classList.toggle('hidden', !authIsRegister);
            document.getElementById('btn-auth-confirm').innerText = authIsRegister ? "Cadastrar" : "Entrar";
        };

        document.getElementById('auth-avatar-input').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                tempAvatar = ev.target.result;
                document.getElementById('auth-avatar-preview').src = tempAvatar;
                document.getElementById('auth-avatar-preview').classList.remove('hidden');
                document.getElementById('auth-cam').classList.add('hidden');
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('btn-auth-confirm').onclick = () => {
            const h = document.getElementById('auth-handle').value.toLowerCase().trim().replace(/[^a-z0-9_]/g, '');
            const p = document.getElementById('auth-pass').value;
            const err = document.getElementById('auth-error-msg');
            err.classList.add('hidden');

            if(authIsRegister) {
                const n = document.getElementById('auth-name').value;
                if(n.length < 4 || h.length < 3 || p.length < 6 || !tempAvatar) {
                    err.innerText = "Dados Inv√°lidos!"; return err.classList.remove('hidden');
                }
                if(dataUsers[h]) { err.innerText = "ID j√° existe!"; return err.classList.remove('hidden'); }
                
                const newUser = { name: n, handle: h, pass: p, avatar: tempAvatar, likes: 0, createdAt: Date.now() };
                set(ref(db, `lacmapper/users/${h}`), newUser).then(()=>{
                    userSession = newUser; localStorage.setItem('lac_user', JSON.stringify(newUser)); window.location.reload();
                });
            } else {
                const u = dataUsers[h];
                if(u && u.pass === p) {
                    userSession = u; localStorage.setItem('lac_user', JSON.stringify(u)); window.location.reload();
                } else {
                    err.innerText = "Acesso Negado!"; err.classList.remove('hidden');
                }
            }
        };

        // --- POST SYSTEM (WITH ADS) ---
        document.getElementById('btn-pre-post').onclick = () => {
            // Smartlink Trigger üíÄ
            window.open('https://www.effectivegatecpm.com/azth964d2r?key=9423dc279cee8c1a20effe84e3b81719', '_blank');
            
            const modal = document.getElementById('modal-interstitial');
            const timer = document.getElementById('inter-timer');
            const btn = document.getElementById('btn-close-interstitial');
            
            modal.classList.remove('hidden');
            btn.disabled = true;
            let count = 5; timer.innerText = count;
            
            const iv = setInterval(()=>{
                count--; timer.innerText = count;
                if(count <= 0) {
                    clearInterval(iv);
                    btn.disabled = false;
                    btn.innerText = "Continuar Upload";
                    btn.classList.remove('opacity-50', 'bg-slate-800');
                    btn.classList.add('bg-blue-600', 'text-white');
                }
            }, 1000);

            btn.onclick = () => {
                modal.classList.add('hidden');
                document.getElementById('modal-post').classList.remove('hidden');
            };
        };

        // --- RENDER ENGINE ---
        function renderMaps(targetGrid = 'map-grid', list = dataMaps) {
            const grid = document.getElementById(targetGrid);
            grid.innerHTML = '';
            
            const q = document.getElementById('input-search').value.toLowerCase();
            let filtered = list.filter(m => m.title.toLowerCase().includes(q) || m.handle.toLowerCase().includes(q));
            
            if(tabMode === 'populares' && targetGrid === 'map-grid') {
                filtered.sort((a,b) => (b.likes||0) - (a.likes||0));
            } else {
                filtered.sort((a,b) => b.time - a.time);
            }

            filtered.forEach(m => {
                // L√≥gica de Coment√°rio Relevante
                let topComm = "Nenhum coment√°rio ainda.";
                if(m.comments) {
                    const cList = Object.values(m.comments).sort((a,b) => (b.likes||0) - (a.likes||0));
                    topComm = cList[0].text;
                }

                const card = document.createElement('div');
                card.className = 'glass rounded-[2.5rem] overflow-hidden flex flex-col card-anim';
                card.innerHTML = `
                    <div class="aspect-[16/9] relative bg-slate-900 overflow-hidden">
                        <img src="${m.image}" class="w-full h-full object-cover">
                        <div class="absolute top-3 right-3 bg-black/60 backdrop-blur px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest text-blue-400">#MAPPING</div>
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="flex items-center gap-3 mb-4 cursor-pointer" onclick="openProfile('${m.handle}')">
                            <img src="${m.avatar}" class="w-8 h-8 rounded-full border border-white/10 object-cover shadow-lg">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter line-clamp-1">@${m.handle}</p>
                        </div>
                        <h3 class="text-base font-black uppercase italic tracking-tighter mb-3 truncate leading-none">${m.title}</h3>
                        
                        <div class="bg-white/5 rounded-2xl p-4 mb-6 border border-white/5 flex items-start gap-2 cursor-pointer" onclick="openComments('${m.id}')">
                            <i data-lucide="message-square" class="w-3 h-3 text-blue-500 mt-1"></i>
                            <p class="text-[9px] text-slate-400 font-medium italic line-clamp-2 leading-relaxed">"${topComm}"</p>
                        </div>

                        <div class="mt-auto flex items-center justify-between border-t border-white/5 pt-4">
                            <div class="flex items-center gap-4">
                                <button class="flex items-center gap-1 text-emerald-500" onclick="voteMap('${m.id}','likes')">
                                    <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                                    <span class="text-[10px] font-black">${m.likes||0}</span>
                                </button>
                                <button class="flex items-center gap-1 text-slate-500" onclick="openComments('${m.id}')">
                                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                                    <span class="text-[10px] font-black">${m.comments?Object.keys(m.comments).length:0}</span>
                                </button>
                            </div>
                            <button class="bg-white text-black px-6 py-2.5 rounded-2xl text-[9px] font-black uppercase shadow-xl" onclick="openDownloadModal('${m.id}')">Baixar</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- PROFILE SYSTEM ---
        window.openProfile = (handle) => {
            const u = dataUsers[handle]; if(!u) return;
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('map-grid').classList.add('hidden');
            document.getElementById('comments-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');

            document.getElementById('prof-img').src = u.avatar;
            document.getElementById('prof-name').innerText = u.name;
            document.getElementById('prof-handle').innerText = `@${u.handle}`;
            document.getElementById('prof-stat-likes').innerText = u.likes || 0;
            document.getElementById('prof-stat-date').innerText = new Date(u.createdAt).toLocaleDateString('pt-BR');

            const maps = dataMaps.filter(m => m.handle === handle);
            document.getElementById('prof-stat-dl').innerText = maps.reduce((a, b) => a + (b.downloads || 0), 0);
            renderMaps('prof-maps-grid', maps);

            document.getElementById('btn-like-profile').onclick = () => {
                if(!userSession) return showToast("Logue primeiro!");
                update(ref(db, `lacmapper/users/${handle}`), { likes: (u.likes || 0) + 1 });
                showToast("Like enviado!");
            };
        };

        // --- COMMENTS SYSTEM ---
        window.openComments = (id) => {
            const m = dataMaps.find(x => x.id === id);
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('map-grid').classList.add('hidden');
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('comments-view').classList.remove('hidden');

            document.getElementById('comm-map-title').innerText = m.title;
            document.getElementById('comment-input-area').classList.toggle('hidden', !userSession);

            document.getElementById('btn-send-comment').onclick = () => {
                const txt = document.getElementById('input-comment').value.trim();
                if(!txt) return;
                const cRef = push(ref(db, `lacmapper/maps/${id}/comments`));
                set(cRef, { 
                    text: txt, author: userSession.name, handle: userSession.handle, 
                    avatar: userSession.avatar, likes: 0, time: Date.now() 
                }).then(()=> {
                    document.getElementById('input-comment').value = '';
                    showToast("Publicado!");
                });
            };

            onValue(ref(db, `lacmapper/maps/${id}/comments`), (snap) => {
                const list = document.getElementById('comments-list'); list.innerHTML = '';
                const data = snap.val();
                if(!data) {
                    list.innerHTML = '<p class="text-center py-12 text-slate-600 font-bold uppercase text-[8px] tracking-widest">Seja o primeiro a opinar.</p>';
                    return;
                }
                Object.entries(data).sort((a,b) => (b[1].likes||0) - (a[1].likes||0)).forEach(([cid, c]) => {
                    const div = document.createElement('div');
                    div.className = 'glass p-5 rounded-[2rem] border-white/5 flex gap-4';
                    div.innerHTML = `
                        <img src="${c.avatar}" class="w-10 h-10 rounded-full object-cover">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-[10px] font-black uppercase">${c.author}</p>
                                <button class="flex items-center gap-1 text-rose-500" onclick="likeComment('${id}','${cid}')">
                                    <i data-lucide="heart" class="w-3 h-3"></i>
                                    <span class="text-[9px] font-bold">${c.likes||0}</span>
                                </button>
                            </div>
                            <p class="text-xs font-medium text-slate-400 leading-relaxed">${c.text}</p>
                        </div>
                    `;
                    list.appendChild(div);
                });
                lucide.createIcons();
            });
        };

        window.likeComment = (mid, cid) => {
            if(!userSession) return showToast("Logue primeiro!");
            const r = ref(db, `lacmapper/maps/${mid}/comments/${cid}`);
            onValue(r, (s) => { if(s.val()) update(r, { likes: (s.val().likes||0) + 1 }); }, {onlyOnce: true});
        };

        // --- DOWNLOAD SYSTEM ---
        window.openDownloadModal = (id) => {
            dlTarget = id;
            const mod = document.getElementById('modal-download');
            const timer = document.getElementById('dl-timer');
            const btn = document.getElementById('btn-confirm-download');
            
            mod.classList.remove('hidden');
            btn.disabled = true;
            btn.classList.add('bg-slate-800', 'text-slate-500');
            btn.classList.remove('bg-blue-600', 'text-white');
            
            let count = 5; timer.innerText = count;
            const iv = setInterval(()=>{
                count--; timer.innerText = count;
                if(count <= 0) {
                    clearInterval(iv);
                    btn.disabled = false;
                    btn.innerText = "Liberar Arquivo";
                    btn.classList.remove('bg-slate-800', 'text-slate-500');
                    btn.classList.add('bg-blue-600', 'text-white');
                }
            }, 1000);

            btn.onclick = () => {
                const m = dataMaps.find(x => x.id === dlTarget);
                const blob = new Blob([m.file], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `${m.title.replace(/\s+/g, '_')}.txt`;
                a.click();
                update(ref(db, `lacmapper/maps/${id}`), { downloads: (m.downloads||0) + 1 });
                mod.classList.add('hidden');
                showToast("Baixando...");
            };
        };

        // --- VOTA√á√ÉO ---
        window.voteMap = (id, f) => {
            if(!userSession) return showToast("Logue primeiro!");
            if(localStorage.getItem(`voted_${id}`)) return showToast("Voto j√° registrado!");
            const m = dataMaps.find(x => x.id === id);
            update(ref(db, `lacmapper/maps/${id}`), { [f]: (m[f]||0) + 1 });
            localStorage.setItem(`voted_${id}`, '1');
        };

        // --- CROP ENGINE ---
        const cImg = document.getElementById('crop-image-element');
        document.getElementById('post-image').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => {
                cImg.src = ev.target.result;
                document.getElementById('crop-area').classList.remove('hidden');
                cropInfo = { x: 0, y: 0, scale: 1 }; updateCrop();
                document.getElementById('image-label').innerText = "‚úì FOTO";
            };
            r.readAsDataURL(e.target.files[0]);
        };
        const updateCrop = () => cImg.style.transform = `translate(${cropInfo.x}px, ${cropInfo.y}px) scale(${cropInfo.scale})`;
        
        // Drag no Crop
        const box = document.getElementById('crop-container');
        const start = (e) => { cropInfo.dragging = true; const cx = e.clientX || e.touches[0].clientX; const cy = e.clientY || e.touches[0].clientY; cropInfo.startX = cx - cropInfo.x; cropInfo.startY = cy - cropInfo.y; };
        const move = (e) => { if(!cropInfo.dragging) return; const cx = e.clientX || e.touches[0].clientX; const cy = e.clientY || e.touches[0].clientY; cropInfo.x = cx - cropInfo.startX; cropInfo.y = cy - cropInfo.startY; updateCrop(); };
        box.addEventListener('mousedown', start); box.addEventListener('touchstart', start);
        window.addEventListener('mousemove', move); window.addEventListener('touchmove', move);
        window.addEventListener('mouseup', ()=>cropInfo.dragging = false); window.addEventListener('touchend', ()=>cropInfo.dragging = false);

        document.getElementById('btn-crop-zoom-in').onclick = () => { cropInfo.scale += 0.2; updateCrop(); };
        document.getElementById('btn-crop-zoom-out').onclick = () => { cropInfo.scale = Math.max(0.1, cropInfo.scale - 0.2); updateCrop(); };

        document.getElementById('btn-trigger-file').onclick = () => document.getElementById('post-file').click();
        document.getElementById('btn-trigger-image').onclick = () => document.getElementById('post-image').click();
        
        document.getElementById('post-file').onchange = (e) => {
            const f = e.target.files[0]; tempFile.size = f.size;
            const r = new FileReader(); r.onload = (ev) => { tempFile.content = ev.target.result; document.getElementById('file-label').innerText = "‚úì TXT"; }; r.readAsText(f);
        };

        document.getElementById('btn-submit-map').onclick = () => {
            const t = document.getElementById('post-title').value.trim();
            const d = document.getElementById('post-desc').value.trim();
            if(!t || !tempFile.content || !cImg.src) return showToast("Faltam dados!");
            
            const btn = document.getElementById('btn-submit-map');
            btn.disabled = true; btn.innerText = "Sincronizando...";

            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 1280; canvas.height = 720;
            const img = new Image(); img.src = cImg.src;
            img.onload = () => {
                ctx.fillStyle="#000"; ctx.fillRect(0,0,1280,720);
                const ratio = 1280 / box.offsetWidth;
                ctx.save();
                ctx.translate(640 + cropInfo.x * ratio, 360 + cropInfo.y * ratio);
                ctx.scale(cropInfo.scale * (1280 / cImg.offsetWidth), cropInfo.scale * (1280 / cImg.offsetWidth));
                ctx.drawImage(img, -img.width/2, -img.height/2);
                ctx.restore();

                const refM = push(ref(db, 'lacmapper/maps'));
                set(refM, {
                    title: t, desc: d, author: userSession.name, handle: userSession.handle, 
                    avatar: userSession.avatar, image: canvas.toDataURL('image/jpeg', 0.8),
                    file: tempFile.content, size: tempFile.size, time: Date.now(), 
                    downloads: 0, likes: 0
                }).then(()=>window.location.reload());
            };
        };

        // --- TABS & SEARCH ---
        document.getElementById('tab-recent').onclick = () => { tabMode = 'recentes'; renderMaps(); document.getElementById('tab-recent').classList.add('active-tab'); document.getElementById('tab-popular').classList.remove('active-tab'); };
        document.getElementById('tab-popular').onclick = () => { tabMode = 'populares'; renderMaps(); document.getElementById('tab-popular').classList.add('active-tab'); document.getElementById('tab-recent').classList.remove('active-tab'); };
        document.getElementById('input-search').oninput = () => renderMaps();
        document.getElementById('btn-trigger-logout').onclick = () => { localStorage.removeItem('lac_user'); window.location.reload(); };
        document.getElementById('btn-close-post').onclick = () => document.getElementById('modal-post').classList.add('hidden');

        // Ad Scaler
        const adjustScale = () => {
            document.querySelectorAll('.ad-slot-main').forEach(slot => {
                const s = slot.querySelector('.ad-scaler-el');
                if(!s) return;
                const sw = slot.offsetWidth;
                if(sw < 728) {
                    const sc = (sw / 728) * 0.95;
                    s.style.transform = `scale(${sc})`;
                    slot.style.height = (90 * sc) + 'px';
                } else {
                    s.style.transform = 'scale(1)';
                    slot.style.height = '90px';
                }
            });
        };
        window.addEventListener('resize', adjustScale);
        setTimeout(adjustScale, 1000);

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>
