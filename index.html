<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>LacMapper™ - Portal de Mapas e Scripts</title>
    <meta name="description" content="A maior comunidade de compartilhamento de mapas e scripts para jogos. Baixe, vote e publique seus mapas no LacMapper™ de graça.">
    <meta name="keywords" content="mapas, scripts, lacmapper, download mapas, portal de mapas, games, editor de mapas">
    <meta name="author" content="LacMapper Team">
    
    <meta property="og:title" content="LacMapper™ - Portal de Mapas">
    <meta property="og:description" content="Os melhores mapas da comunidade estão aqui. Publique o seu também!">
    <meta property="og:image" content="1000132243.png">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #f1f5f9; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .active-tab { color: #3b82f6; border-bottom: 3px solid #3b82f6; }
        #crop-container { aspect-ratio: 16/9; overflow: hidden; position: relative; background: #000; border-radius: 16px; touch-action: none; border: 2px solid rgba(59, 130, 246, 0.3); }
        #crop-image { position: absolute; cursor: move; touch-action: none; user-select: none; max-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button { cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .card-anim { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; pointer-events: none !important; }

        /* Estilo para o slot de anúncio */
        .ad-slot-main {
            width: 100%;
            max-width: 728px;
            min-height: 90px;
            margin: 20px auto;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            overflow-x: auto;
            font-size: 10px;
            color: #444;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="pb-24 min-h-screen flex flex-col">

    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[110] hidden pointer-events-none transition-all duration-300">
        <div class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-white/20">
            <span id="toast-text" class="text-[10px] font-black uppercase tracking-wider"></span>
        </div>
    </div>

    <nav class="fixed top-0 w-full z-50 glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center overflow-hidden border border-white/10 shadow-lg">
                    <img src="1000132243.png" alt="LacMapper Logo" class="w-full h-full object-contain p-1">
                </div>
                <span class="text-xl font-black italic tracking-tighter uppercase hidden xs:block">LacMapper™</span>
            </div>

            <div class="flex items-center gap-3">
                <div id="nav-unlogged">
                    <button id="btn-trigger-login" class="bg-white text-black text-[10px] font-black uppercase px-6 py-2.5 rounded-full shadow-lg">Entrar</button>
                </div>
                <div id="nav-logged" class="hidden flex items-center gap-3">
                    <img id="nav-avatar" class="w-9 h-9 rounded-full border-2 border-blue-500/50 object-cover shadow-lg" src="">
                    <button id="btn-trigger-post" class="bg-blue-600 text-white p-2.5 rounded-xl shadow-lg">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                    <button id="btn-trigger-logout" class="p-2 text-slate-500 hover:text-rose-500 transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <header class="pt-24 px-4 max-w-7xl mx-auto w-full">
        <div class="flex items-center gap-4 border-b border-white/5 mb-8 overflow-x-auto no-scrollbar">
            <button id="tab-recent" class="px-5 py-4 text-[10px] font-black uppercase tracking-[0.25em] active-tab transition-all whitespace-nowrap">Recentes</button>
            <button id="tab-popular" class="px-5 py-4 text-[10px] font-black uppercase tracking-[0.25em] text-slate-500 transition-all whitespace-nowrap">Populares</button>
        </div>
        
        <div class="relative max-w-lg mb-6 mx-auto">
            <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-500 w-5 h-5"></i>
            <input type="text" id="input-search" placeholder="Pesquisar mapas ou autores..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-4.5 pl-14 pr-6 outline-none focus:ring-2 focus:ring-blue-500/50 transition-all text-sm font-bold">
        </div>

        <div class="ad-slot-main">
            <script type="text/javascript">
              atOptions = {
              	'key' : 'f2fc11825c77506816279c5b1393084e',
              	'format' : 'iframe',
              	'height' : 90,
              	'width' : 728,
              	'params' : {}
              };
            </script>
            <script type="text/javascript" src="https://www.highperformanceformat.com/f2fc11825c77506816279c5b1393084e/invoke.js"></script>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 flex-grow w-full">
        <div id="loading" class="py-24 text-center">
            <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-black uppercase text-slate-600 tracking-widest text-[10px]">Sincronizando Banco de Dados™...</p>
        </div>
        <div id="map-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    </main>

    <div id="modal-auth" class="fixed inset-0 z-[100] glass flex items-center justify-center p-4 hidden">
        <div class="bg-[#0f172a] w-full max-w-md rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden flex flex-col animate-in zoom-in duration-300">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                <h3 id="auth-header-title" class="font-black uppercase tracking-tighter italic text-xl">Fazer Login</h3>
                <button id="btn-close-auth" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="p-8 space-y-5 overflow-y-auto no-scrollbar max-h-[80vh]">
                <div id="auth-register-only" class="hidden space-y-5">
                    <div class="flex flex-col items-center gap-3">
                        <label class="relative cursor-pointer">
                            <div class="w-20 h-20 rounded-full bg-slate-800 border-2 border-dashed border-white/20 flex items-center justify-center overflow-hidden">
                                <img id="auth-avatar-preview" class="w-full h-full object-cover hidden" src="">
                                <i id="auth-avatar-icon" data-lucide="camera" class="text-slate-500"></i>
                            </div>
                            <input id="auth-avatar-input" type="file" accept="image/*" class="hidden">
                        </label>
                        <span class="text-[9px] font-black uppercase text-slate-500 tracking-widest">Foto de Perfil</span>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block">Nome Completo</label>
                        <input id="auth-name" type="text" placeholder="Mínimo 4 letras" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500 transition-all font-bold">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Identificador</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-blue-500 italic">@</span>
                        <input id="auth-handle" type="text" placeholder="teunome" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 pl-9 outline-none focus:border-blue-500 transition-all font-bold lowercase">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Senha</label>
                    <input id="auth-pass" type="password" placeholder="Mínimo 8 dígitos" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500 transition-all font-bold">
                </div>
                <div id="auth-register-pass-confirm" class="hidden">
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Confirmar Senha</label>
                    <input id="auth-pass-confirm" type="password" placeholder="Repete a senha" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500 transition-all font-bold">
                </div>
                <div id="auth-error-msg" class="text-rose-500 text-[10px] font-black uppercase text-center hidden">Informações Inválidas</div>
                <button id="btn-auth-confirm" class="w-full bg-blue-600 py-5 rounded-[1.5rem] text-sm font-black uppercase shadow-xl active:scale-95 transition-all">Entrar</button>
                <p id="btn-auth-toggle" class="text-center text-[10px] font-bold text-slate-500 uppercase tracking-widest cursor-pointer hover:text-white transition-colors py-2">Não tens conta? Criar Agora</p>
            </div>
        </div>
    </div>

    <div id="modal-post" class="fixed inset-0 z-[100] glass flex items-center justify-center p-4 hidden">
        <div class="bg-[#0f172a] w-full max-w-lg rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                <h3 class="font-black uppercase tracking-tighter italic text-xl">Novo Mapa</h3>
                <button id="btn-close-post" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto no-scrollbar">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Título do Mapa</label>
                    <input id="post-title" type="text" placeholder="Nome do mapa..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500 transition-all font-bold">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Descrição</label>
                    <textarea id="post-desc" placeholder="Detalhes sobre o mapa..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:border-blue-500 transition-all font-medium text-sm h-24 no-scrollbar"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-black uppercase text-slate-500 block tracking-widest text-center">Ficheiro (.txt)</label>
                        <input id="post-file" type="file" accept=".txt" class="hidden">
                        <button id="btn-trigger-file" class="w-full bg-white/5 border-2 border-dashed border-white/10 rounded-2xl py-8 flex flex-col items-center gap-2 hover:bg-white/10 transition-all">
                            <i data-lucide="file-text" class="text-blue-500 w-8 h-8"></i>
                            <span id="file-label" class="text-[9px] font-black uppercase text-slate-400">Selecionar</span>
                        </button>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-black uppercase text-slate-500 block tracking-widest text-center">Capa 16:9</label>
                        <input id="post-image" type="file" accept="image/*" class="hidden">
                        <button id="btn-trigger-image" class="w-full bg-white/5 border-2 border-dashed border-white/10 rounded-2xl py-8 flex flex-col items-center gap-2 hover:bg-white/10 transition-all">
                            <i data-lucide="image" class="text-blue-500 w-8 h-8"></i>
                            <span id="image-label" class="text-[9px] font-black uppercase text-slate-400">Galeria</span>
                        </button>
                    </div>
                </div>
                <div id="crop-area" class="hidden space-y-4">
                    <div id="crop-container"><img id="crop-image-element" src=""></div>
                    <div class="flex items-center justify-between px-3">
                        <span class="text-[10px] font-bold text-slate-500 uppercase italic">Enquadra a Foto</span>
                        <div class="flex gap-3">
                            <button id="btn-crop-zoom-out" class="bg-white/5 p-3 rounded-xl"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <button id="btn-crop-zoom-in" class="bg-white/10 p-3 rounded-xl"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-white/5 border-t border-white/10">
                <button id="btn-submit-map" class="w-full bg-blue-600 py-5 rounded-[1.5rem] text-sm font-black uppercase shadow-xl active:scale-95 transition-all">Publicar Agora</button>
            </div>
        </div>
    </div>

    <footer class="mt-auto py-12 border-t border-white/5 bg-slate-950/50 text-center">
        <div class="text-[11px] font-black uppercase tracking-[0.5em] mb-4 text-slate-400 italic">LacMapper™ 2025</div>
        <div class="flex justify-center gap-6 text-[9px] font-black uppercase tracking-widest text-slate-600">
            <span>Sobre</span>
            <span>Regras</span>
            <span>Discord</span>
        </div>
    </footer>

    <div class="fixed bottom-0 left-0 w-full glass h-20 z-50 flex items-center justify-center border-t border-white/10 sm:hidden">
        <span class="text-[9px] text-slate-600">Publicidade</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKhcg84B_EqFKJ6Xe_EZnW1KRq-T_gcwU",
            authDomain: "jogo2donline.firebaseapp.com",
            databaseURL: "https://jogo2donline-default-rtdb.firebaseio.com",
            projectId: "jogo2donline",
            storageBucket: "jogo2donline.firebasestorage.app",
            messagingSenderId: "782226902162",
            appId: "1:782226902162:web:d316d0b3a62acac6afaa4b",
            measurementId: "G-XDW14K64TV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let userSession = JSON.parse(localStorage.getItem('lac_user')) || null;
        let dataMaps = [];
        let dataUsers = {};
        let tabMode = 'recentes';
        let authIsRegister = false;
        let cropInfo = { x: 0, y: 0, scale: 1, dragging: false, startX: 0, startY: 0 };
        let tempAvatar = "";
        let tempFile = { content: "", size: 0 };

        const startSync = () => {
            onValue(ref(db, 'lacmapper/users'), (snap) => { dataUsers = snap.val() || {}; });
            onValue(ref(db, 'lacmapper/maps'), (snap) => {
                const raw = snap.val();
                dataMaps = [];
                if (raw) for (let key in raw) dataMaps.push({ ...raw[key], id: key });
                document.getElementById('loading').classList.add('hidden');
                renderMaps();
            });
        };
        startSync();

        const refreshAuthUI = () => {
            const navUnlogged = document.getElementById('nav-unlogged');
            const navLogged = document.getElementById('nav-logged');
            if (userSession) {
                navUnlogged.classList.add('hidden');
                navLogged.classList.remove('hidden');
                document.getElementById('nav-avatar').src = userSession.avatar;
            } else {
                navUnlogged.classList.remove('hidden');
                navLogged.classList.add('hidden');
            }
        };
        refreshAuthUI();

        document.getElementById('btn-trigger-login').addEventListener('click', () => {
            authIsRegister = false;
            updateAuthModalView();
            document.getElementById('modal-auth').classList.remove('hidden');
        });

        document.getElementById('btn-auth-toggle').addEventListener('click', () => {
            authIsRegister = !authIsRegister;
            updateAuthModalView();
        });

        const updateAuthModalView = () => {
            document.getElementById('auth-header-title').innerText = authIsRegister ? "Criar Conta" : "Fazer Login";
            document.getElementById('btn-auth-confirm').innerText = authIsRegister ? "Cadastrar" : "Entrar";
            document.getElementById('btn-auth-toggle').innerText = authIsRegister ? "Já tens conta? Entrar" : "Não tens conta? Criar Agora";
            document.getElementById('auth-register-only').classList.toggle('hidden', !authIsRegister);
            document.getElementById('auth-register-pass-confirm').classList.toggle('hidden', !authIsRegister);
            document.getElementById('auth-error-msg').classList.add('hidden');
        };

        document.getElementById('auth-avatar-input').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                tempAvatar = ev.target.result;
                document.getElementById('auth-avatar-preview').src = tempAvatar;
                document.getElementById('auth-avatar-preview').classList.remove('hidden');
                document.getElementById('auth-avatar-icon').classList.add('hidden');
            };
            reader.readAsDataURL(f);
        });

        document.getElementById('btn-auth-confirm').addEventListener('click', async () => {
            const handle = document.getElementById('auth-handle').value.toLowerCase().replace(/[^a-z_]/g, '');
            const pass = document.getElementById('auth-pass').value;
            const err = document.getElementById('auth-error-msg');
            err.classList.add('hidden');

            if (authIsRegister) {
                const name = document.getElementById('auth-name').value;
                const passConfirm = document.getElementById('auth-pass-confirm').value;
                if (name.length < 4 || handle.length < 3 || pass.length < 8 || !tempAvatar) {
                    err.innerText = "Dados Inválidos ou Curtos!";
                    return err.classList.remove('hidden');
                }
                if (pass !== passConfirm) {
                    err.innerText = "As senhas não coincidem!";
                    return err.classList.remove('hidden');
                }
                if (dataUsers[handle]) {
                    err.innerText = "Este @identificador já existe!";
                    return err.classList.remove('hidden');
                }
                const userData = { name, handle, avatar: tempAvatar, pass };
                set(ref(db, 'lacmapper/users/' + handle), userData).then(() => {
                    userSession = userData;
                    localStorage.setItem('lac_user', JSON.stringify(userData));
                    document.getElementById('modal-auth').classList.add('hidden');
                    refreshAuthUI();
                    showToast("Conta criada!");
                });
            } else {
                const u = dataUsers[handle];
                if (u && u.pass === pass) {
                    userSession = u;
                    localStorage.setItem('lac_user', JSON.stringify(u));
                    document.getElementById('modal-auth').classList.add('hidden');
                    refreshAuthUI();
                    showToast("Login realizado!");
                    renderMaps();
                } else {
                    err.innerText = "Informações Inválidas";
                    err.classList.remove('hidden');
                }
            }
        });

        document.getElementById('btn-trigger-logout').addEventListener('click', () => {
            localStorage.removeItem('lac_user');
            userSession = null;
            refreshAuthUI();
            renderMaps();
        });

        const cropImg = document.getElementById('crop-image-element');
        document.getElementById('post-image').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                cropImg.src = ev.target.result;
                document.getElementById('crop-area').classList.remove('hidden');
                cropInfo = { x: 0, y: 0, scale: 1, dragging: false };
                updateCropStyle();
                document.getElementById('image-label').innerText = "✓ FOTO";
            };
            reader.readAsDataURL(f);
        });

        const updateCropStyle = () => {
            cropImg.style.transform = `translate(${cropInfo.x}px, ${cropInfo.y}px) scale(${cropInfo.scale})`;
        };

        const cropBox = document.getElementById('crop-container');
        const onStart = (e) => {
            cropInfo.dragging = true;
            const cx = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const cy = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            cropInfo.startX = cx - cropInfo.x;
            cropInfo.startY = cy - cropInfo.y;
        };
        const onMove = (e) => {
            if (!cropInfo.dragging) return;
            const cx = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const cy = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            cropInfo.x = cx - cropInfo.startX;
            cropInfo.y = cy - cropInfo.startY;
            updateCropStyle();
        };
        cropBox.addEventListener('mousedown', onStart);
        cropBox.addEventListener('touchstart', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove);
        window.addEventListener('mouseup', () => cropInfo.dragging = false);
        window.addEventListener('touchend', () => cropInfo.dragging = false);

        document.getElementById('btn-crop-zoom-in').addEventListener('click', () => { cropInfo.scale += 0.2; updateCropStyle(); });
        document.getElementById('btn-crop-zoom-out').addEventListener('click', () => { cropInfo.scale = Math.max(0.1, cropInfo.scale - 0.2); updateCropStyle(); });

        document.getElementById('post-file').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            tempFile.size = f.size;
            const reader = new FileReader();
            reader.onload = (ev) => {
                tempFile.content = ev.target.result;
                document.getElementById('file-label').innerText = "✓ TXT";
            };
            reader.readAsText(f);
        });

        document.getElementById('btn-submit-map').addEventListener('click', async () => {
            const title = document.getElementById('post-title').value;
            const desc = document.getElementById('post-desc').value;
            if (!title || !tempFile.content || !cropImg.src) return showToast("Faltam informações!");

            const btn = document.getElementById('btn-submit-map');
            btn.disabled = true; btn.innerText = "A Enviar...";

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1280; canvas.height = 720;
            const img = new Image();
            img.src = cropImg.src;
            img.onload = () => {
                ctx.fillStyle = "#000"; ctx.fillRect(0,0,1280,720);
                const r = 1280 / cropBox.offsetWidth;
                ctx.save();
                ctx.translate(640 + cropInfo.x * r, 360 + cropInfo.y * r);
                ctx.scale(cropInfo.scale * (1280 / cropImg.offsetWidth), cropInfo.scale * (1280 / cropImg.offsetWidth));
                ctx.drawImage(img, -img.width/2, -img.height/2);
                ctx.restore();

                const refNew = push(ref(db, 'lacmapper/maps'));
                set(refNew, {
                    title, desc: desc || "Sem descrição.",
                    author: userSession.name, handle: userSession.handle, avatar: userSession.avatar,
                    image: canvas.toDataURL('image/jpeg', 0.8),
                    file: tempFile.content, size: tempFile.size,
                    downloads: 0, likes: 0, dislikes: 0, time: Date.now()
                }).then(() => {
                    document.getElementById('modal-post').classList.add('hidden');
                    showToast("Mapa publicado!");
                    btn.disabled = false; btn.innerText = "Publicar Agora";
                    resetPostModal();
                });
            };
        });

        const resetPostModal = () => {
            document.getElementById('post-title').value = "";
            document.getElementById('post-desc').value = "";
            document.getElementById('crop-area').classList.add('hidden');
            document.getElementById('file-label').innerText = "Selecionar";
            document.getElementById('image-label').innerText = "Galeria";
            tempFile = { content: "", size: 0 };
        };

        const getWeight = (b) => b < 1048576 ? (b/1024).toFixed(0) + ' KB' : (b/1048576).toFixed(1) + ' MB';

        function renderMaps() {
            const grid = document.getElementById('map-grid');
            grid.innerHTML = '';
            let list = [...dataMaps];
            if (tabMode === 'populares') list.sort((a,b) => (b.likes - b.dislikes) - (a.likes - a.dislikes));
            else list.sort((a,b) => b.time - a.time);
            const q = document.getElementById('input-search').value.toLowerCase();
            const filtered = list.filter(m => m.title.toLowerCase().includes(q) || m.handle.toLowerCase().includes(q));

            filtered.forEach(map => {
                const date = new Intl.DateTimeFormat('pt-BR', { day: 'numeric', month: 'short' }).format(map.time);
                const card = document.createElement('div');
                card.className = 'glass rounded-[2.5rem] overflow-hidden flex flex-col card-anim';
                card.innerHTML = `
                    <div class="aspect-[16/9] overflow-hidden bg-slate-900 relative">
                        <img src="${map.image}" class="w-full h-full object-cover">
                        <div class="absolute bottom-3 left-3 flex gap-1">
                             <span class="text-[7px] font-black uppercase tracking-widest px-2.5 py-1 bg-black/60 backdrop-blur rounded-full text-white">${date}</span>
                             <span class="text-[7px] font-black uppercase tracking-widest px-2.5 py-1 bg-black/60 backdrop-blur rounded-full text-blue-400 font-bold">${getWeight(map.size)}</span>
                        </div>
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-base font-black uppercase italic tracking-tighter truncate leading-none">${map.title}</h3>
                            <div class="flex items-center gap-1 text-slate-500">
                                <i data-lucide="download" class="w-3 h-3"></i>
                                <span class="text-[9px] font-black">${map.downloads}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mb-3">
                            <img src="${map.avatar}" class="w-4 h-4 rounded-full border border-white/10 object-cover">
                            <p class="text-[8px] font-bold text-blue-500 uppercase tracking-widest">@${map.handle}</p>
                        </div>
                        <p class="text-[9px] text-slate-400 font-medium mb-5 line-clamp-2 h-7 italic opacity-70">${map.desc}</p>
                        <div class="mt-auto flex items-center justify-between border-t border-white/5 pt-4">
                            <div class="flex items-center gap-3">
                                <button class="btn-up flex items-center gap-1.5 text-emerald-500 active:scale-90" data-id="${map.id}">
                                    <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                                    <span class="text-[10px] font-black">${map.likes}</span>
                                </button>
                                <button class="btn-down flex items-center gap-1.5 text-rose-500 active:scale-90" data-id="${map.id}">
                                    <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                                    <span class="text-[10px] font-black">${map.dislikes}</span>
                                </button>
                            </div>
                            <button class="btn-dl bg-white text-black px-5 py-2.5 rounded-xl text-[9px] font-black uppercase active:scale-90 shadow-lg" data-id="${map.id}">Baixar</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            document.querySelectorAll('.btn-up').forEach(b => b.addEventListener('click', () => voteMap(b.dataset.id, 'likes')));
            document.querySelectorAll('.btn-down').forEach(b => b.addEventListener('click', () => voteMap(b.dataset.id, 'dislikes')));
            document.querySelectorAll('.btn-dl').forEach(b => b.addEventListener('click', () => downloadMap(b.dataset.id)));
            lucide.createIcons();
        }

        const voteMap = (id, field) => {
            if (!userSession) return showToast("Logue primeiro!");
            if (localStorage.getItem('voted_' + id)) return showToast("Já votou!");
            const target = dataMaps.find(m => m.id === id);
            update(ref(db, 'lacmapper/maps/' + id), { [field]: (target[field] || 0) + 1 });
            localStorage.setItem('voted_' + id, '1');
        };

        const downloadMap = (id) => {
            const m = dataMaps.find(m => m.id === id);
            const fileName = m.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_') + '.txt';
            const b = new Blob([m.file], { type: 'text/plain' });
            const u = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            update(ref(db, 'lacmapper/maps/' + id), { downloads: (m.downloads || 0) + 1 });
            showToast("Baixando...");
        };

        document.getElementById('btn-close-auth').onclick = () => document.getElementById('modal-auth').classList.add('hidden');
        document.getElementById('btn-close-post').onclick = () => document.getElementById('modal-post').classList.add('hidden');
        document.getElementById('btn-trigger-post').onclick = () => document.getElementById('modal-post').classList.remove('hidden');
        document.getElementById('tab-recent').onclick = () => { tabMode = 'recentes'; updateTabUI(); renderMaps(); };
        document.getElementById('tab-popular').onclick = () => { tabMode = 'populares'; updateTabUI(); renderMaps(); };
        const updateTabUI = () => {
            document.getElementById('tab-recent').classList.toggle('active-tab', tabMode === 'recentes');
            document.getElementById('tab-popular').classList.toggle('active-tab', tabMode === 'populares');
        };

        document.getElementById('input-search').addEventListener('input', renderMaps);
        document.getElementById('btn-trigger-file').onclick = () => document.getElementById('post-file').click();
        document.getElementById('btn-trigger-image').onclick = () => document.getElementById('post-image').click();

        function showToast(txt) {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = txt;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>
